{
  "hash": "6f315e2897b9f9da5d0d30686bcd0788",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Spatial Predictive Analysis: Predicting Burglaries with Sanitation Violations\"\nauthor: \"Fan Yang\"\ndate: \"November 15, 2025\"\nformat:\n  html:\n    code-fold: show\n    code-tools: true\n    toc: true\n    toc-depth: 3\n    toc-location: left\n    theme: cosmo\n    embed-resources: true\neditor: visual\nexecute:\n  warning: false\n  message: false\n---\n\n## Introduction\n\nThis analysis constructs a spatial prediction model for Chicago burglaries, with sanitation code violations as the primary predictor variable. It hypothesizes that sanitation violations may also correlate with burglary risk, drawing on the “broken windows” theory—where visible signs of disorder, such as uncollected trash or violations, indicate diminished social control and may trigger criminal activity. Based on this premise, the analysis explores how community disorder indicators relate to property crime patterns by testing whether sanitation complaints can predict burglary locations.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(here)\nlibrary(viridis)\nlibrary(terra)\nlibrary(spdep)\nlibrary(FNN)\nlibrary(MASS)\nlibrary(patchwork)\nlibrary(knitr)\nlibrary(kableExtra)\nlibrary(classInt)\nlibrary(spatstat.geom)\nlibrary(spatstat.explore)\n\noptions(scipen = 999)\nset.seed(1115)\n\ntheme_spatial <- function(base_size = 11) {\n  theme_minimal(base_size = base_size) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = base_size + 1),\n      plot.subtitle = element_text(color = \"gray30\", size = base_size - 1),\n      legend.position = \"right\",\n      panel.grid.minor = element_blank(),\n      axis.text = element_blank(),\n      axis.title = element_blank()\n    )\n}\n\ntheme_set(theme_spatial())\n```\n:::\n\n\n## Part 1: Data Loading and Exploration\n\n### Load Spatial Boundaries\n\n\n::: {.cell}\n\n```{.r .cell-code}\npoliceDistricts <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON\") %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(District = dist_num)\n\npoliceBeats <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/n9it-hstw?method=export&format=GeoJSON\") %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(Beat = beat_num)\n\nchicagoBoundary <- \n  st_read(\"https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson\") %>%\n  st_transform('ESRI:102271')\n```\n:::\n\n\n### Load Burglary Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nburglaries <- st_read(here(\"assignments\", \"assignment_4\", \"data\", \"burglaries.shp\")) %>% \n  st_transform('ESRI:102271')\n```\n:::\n\n\nThe dataset contains 7,482 burglary incidents from 2017.\n\n### Load Sanitation Violation Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nviolations_raw <- read_csv(\n  here(\"assignments\", \"assignment_4\", \"data\", \"311_data.csv\"),\n  show_col_types = FALSE\n)\n\nviolations <- violations_raw %>%\n  filter(`Type of Service Request` == \"Sanitation Code Violation\") %>%\n  filter(!is.na(Latitude) & !is.na(Longitude)) %>%\n  st_as_sf(coords = c(\"Longitude\", \"Latitude\"), crs = 4326) %>%\n  st_transform('ESRI:102271')\n```\n:::\n\n\nThe sanitation violations dataset contains 152,636 complaints from 2017, including issues like improper garbage disposal, rodent infestations, and unsanitary property conditions.\n\n### Visualize Spatial Distribution\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_sf(data = burglaries, color = \"#d62828\", size = 0.1, alpha = 0.3) +\n  labs(\n    title = \"Burglary Locations\",\n    subtitle = paste0(\"n = \", format(nrow(burglaries), big.mark=\",\"))\n  ) +\n  theme_void()\n\np2 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_sf(data = violations, color = \"#457b9d\", size = 0.1, alpha = 0.3) +\n  labs(\n    title = \"Sanitation Violations\",\n    subtitle = paste0(\"n = \", format(nrow(violations), big.mark=\",\"))\n  ) +\n  theme_void()\n\np1 + p2 + \n  plot_annotation(title = \"Spatial Distribution: Burglaries and Sanitation Violations\")\n```\n\n::: {.cell-output-display}\n![](Fan_Yang_Assignment4_files/figure-html/visualize-data-1.png){width=960}\n:::\n:::\n\n\nBoth datasets reveal a certain spatial clustering effect, with hot spots concentrated in similar areas (though sanitation code violations are more prevalent). Sanitation code violations appear to be a useful indicator for predicting the risk of residential burglary.\n\n## Part 2: Fishnet Grid Creation\n\n### Create and Aggregate Grid\n\n500m x 500m fishnet grid.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet <- st_make_grid(\n  chicagoBoundary,\n  cellsize = 500,\n  square = TRUE\n) %>%\n  st_sf() %>%\n  mutate(uniqueID = row_number())\n\nfishnet <- fishnet[chicagoBoundary, ]\n```\n:::\n\n\n### Aggregate Burglaries to Grid\n\n\n::: {.cell}\n\n```{.r .cell-code}\nburglaries_fishnet <- st_join(burglaries, fishnet, join = st_within) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarize(countBurglaries = n())\n\nfishnet <- fishnet %>%\n  left_join(burglaries_fishnet, by = \"uniqueID\") %>%\n  mutate(countBurglaries = replace_na(countBurglaries, 0))\n```\n:::\n\n\n### Aggregate Sanitation Violations to Grid\n\n\n::: {.cell}\n\n```{.r .cell-code}\nviolations_fishnet <- st_join(violations, fishnet, join = st_within) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarize(sanitation_violations = n())\n\nfishnet <- fishnet %>%\n  left_join(violations_fishnet, by = \"uniqueID\") %>%\n  mutate(sanitation_violations = replace_na(sanitation_violations, 0))\n```\n:::\n\n\n### Summary Statistics\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata.frame(\n  Variable = c(\"Burglaries\", \"Sanitation Violations\"),\n  Min = c(min(fishnet$countBurglaries), min(fishnet$sanitation_violations)),\n  Median = c(median(fishnet$countBurglaries), median(fishnet$sanitation_violations)),\n  Mean = c(round(mean(fishnet$countBurglaries), 2), round(mean(fishnet$sanitation_violations), 2)),\n  Max = c(max(fishnet$countBurglaries), max(fishnet$sanitation_violations)),\n  `Cells with Zero` = c(\n    paste0(sum(fishnet$countBurglaries == 0), \" (\", round(100 * sum(fishnet$countBurglaries == 0) / nrow(fishnet), 1), \"%)\"),\n    paste0(sum(fishnet$sanitation_violations == 0), \" (\", round(100 * sum(fishnet$sanitation_violations == 0) / nrow(fishnet), 1), \"%)\")\n  )\n) %>%\n  kable(caption = \"Distribution Summary\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Distribution Summary</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Variable </th>\n   <th style=\"text-align:right;\"> Min </th>\n   <th style=\"text-align:right;\"> Median </th>\n   <th style=\"text-align:right;\"> Mean </th>\n   <th style=\"text-align:right;\"> Max </th>\n   <th style=\"text-align:left;\"> Cells.with.Zero </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Burglaries </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 3.04 </td>\n   <td style=\"text-align:right;\"> 40 </td>\n   <td style=\"text-align:left;\"> 781 (31.8%) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Sanitation Violations </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n   <td style=\"text-align:right;\"> 62.02 </td>\n   <td style=\"text-align:right;\"> 727 </td>\n   <td style=\"text-align:left;\"> 306 (12.4%) </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Visualize Aggregated Counts\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = sanitation_violations), color = NA) +\n  scale_fill_viridis_c(\n    name = \"Count\",\n    option = \"mako\",\n    trans = \"log1p\"\n  ) +\n  labs(title = \"Sanitation Violations per Cell\") +\n  theme_void()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +\n  scale_fill_viridis_c(\n    name = \"Count\",\n    option = \"plasma\",\n    trans = \"log1p\"\n  ) +\n  labs(title = \"Burglaries per Cell\") +\n  theme_void()\n\np1 + p2 +\n  plot_annotation(\n    title = \"Spatial Relationship: Sanitation Violations and Burglaries\",\n    subtitle = \"Do high-violation areas correspond to high-burglary areas?\"\n  )\n```\n\n::: {.cell-output-display}\n![](Fan_Yang_Assignment4_files/figure-html/visualize-fishnet-1.png){width=960}\n:::\n:::\n\n\nThese two maps reveal substantial spatial overlap between sanitation violation hot spots and residential burglary hot spots.\n\n## Part 3: Spatial Features\n\n### Calculate Nearest Neighbor Distance\n\nIt measures the average distance from each cell to the three nearest sanitation violations, capturing local exposure to disorder.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet_coords <- st_coordinates(st_centroid(fishnet))\nviolations_coords <- st_coordinates(violations)\n\nnn_result <- get.knnx(violations_coords, fishnet_coords, k = 3)\n\nfishnet <- fishnet %>%\n  mutate(sanitation.nn = rowMeans(nn_result$nn.dist))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = sanitation.nn), color = NA) +\n  scale_fill_viridis_c(\n    option = \"viridis\",\n    direction = -1,\n    name = \"Distance (ft)\",\n    trans = \"log1p\"\n  ) +\n  labs(\n    title = \"Average Distance to 3 Nearest Sanitation Violations\",\n    subtitle = \"Lower values indicate proximity to disorder hot spots\"\n  ) +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](Fan_Yang_Assignment4_files/figure-html/plot-nn-1.png){width=768}\n:::\n:::\n\n\nCells with low values are located in areas with concentrated sanitation problems. If the broken windows theory holds, it means that these areas may face elevated burglary risk.\n\n### Local Moran's I Analysis\n\nI identify statistically significant clusters of sanitation violations using LISA to pinpoint disorder hot spots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords <- st_coordinates(st_centroid(fishnet))\nfishnet_nb <- knn2nb(knearneigh(coords, k = 5))\nfishnet_weights <- nb2listw(fishnet_nb, style = \"W\", zero.policy = TRUE)\n\nlocal_moran <- localmoran(fishnet$sanitation_violations, fishnet_weights, zero.policy = TRUE)\n\nfishnet <- fishnet %>%\n  mutate(\n    localMorans = local_moran[, 1],\n    localMorans_pval = local_moran[, 5],\n    sig_hotspot = localMorans > 0 & localMorans_pval <= 0.05\n  )\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = localMorans), color = NA) +\n  scale_fill_gradient2(\n    low = \"#2166ac\", mid = \"white\", high = \"#b2182b\",\n    midpoint = 0,\n    name = \"Local\\nMoran's I\"\n  ) +\n  labs(title = \"Local Moran's I Statistic\") +\n  theme_void()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = sig_hotspot), color = NA) +\n  scale_fill_manual(\n    values = c(\"gray90\", \"#d62828\"),\n    labels = c(\"Not Significant\", \"Hot Spot (p ≤ 0.05)\"),\n    name = \"\"\n  ) +\n  labs(title = \"Significant Hot Spots\") +\n  theme_void()\n\np1 + p2\n```\n\n::: {.cell-output-display}\n![](Fan_Yang_Assignment4_files/figure-html/plot-hotspots-1.png){width=960}\n:::\n:::\n\n\nLISA reveals 540 cells that are statistically significant hot spots, representing areas where high sanitation violation counts cluster together. The central and south-central regions have a higher concentration.\n\n### Distance to Hot Spots\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotspot_cells <- fishnet %>% filter(sig_hotspot == TRUE)\n\nif(nrow(hotspot_cells) > 0) {\n  hotspot_union <- st_union(hotspot_cells)\n  \n  fishnet <- fishnet %>%\n    mutate(\n      dist_to_hotspot = as.numeric(st_distance(st_centroid(.), hotspot_union))\n    )\n} else {\n  fishnet <- fishnet %>% mutate(dist_to_hotspot = NA)\n}\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = dist_to_hotspot), color = NA) +\n  scale_fill_viridis_c(\n    option = \"plasma\",\n    direction = -1,\n    name = \"Distance (ft)\",\n    trans = \"log1p\",\n    breaks = c(0, 500, 1000, 4000)\n  ) +\n  geom_sf(data = filter(fishnet, sig_hotspot == TRUE), \n          fill = NA, color = \"red\", size = 0.3) +\n  labs(\n    title = \"Distance to Nearest Sanitation Hot Spot\",\n    subtitle = \"Red outlines = significant clusters\"\n  ) +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](Fan_Yang_Assignment4_files/figure-html/plot-distance-1.png){width=768}\n:::\n:::\n\n\nThe map reveals multiple sanitation violation hotspots in Chicago, primarily concentrated in the city's south central area, while the northern regions remain distant from these problem zones.\n\n### Kernel Density Estimation Baseline\n\n\n::: {.cell}\n\n```{.r .cell-code}\nburglary_ppp <- as.ppp(\n  st_coordinates(burglaries),\n  W = as.owin(st_bbox(chicagoBoundary))\n)\n\nkde_result <- density.ppp(\n  burglary_ppp,\n  sigma = 1000,\n  edge = TRUE\n)\n\nkde_raster <- rast(kde_result)\ncrs(kde_raster) <- \"ESRI:102271\"\n\nfishnet_centroids <- st_centroid(fishnet)\nfishnet$kde_value <- terra::extract(kde_raster, vect(fishnet_centroids))[, 2]\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = kde_value), color = NA) +\n  scale_fill_viridis_c(\n    option = \"turbo\",\n    name = \"Density\"\n  ) +\n  labs(\n    title = \"Kernel Density Estimation of Burglaries\",\n    subtitle = \"Baseline prediction using only spatial distribution\"\n  ) +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](Fan_Yang_Assignment4_files/figure-html/plot-kde-1.png){width=768}\n:::\n:::\n\n\nKDE as a baseline—it predicts burglary risk solely based on past locations. An effective regression model should theoretically outperform this.\n\n## Part 4: Count Regression Models\n\n### Prepare Modeling Dataset\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet_centroids_with_id <- st_centroid(fishnet) %>%\n  mutate(uniqueID = fishnet$uniqueID)\n\nfishnet_districts <- st_join(\n  fishnet_centroids_with_id,\n  policeDistricts\n) %>%\n  st_drop_geometry() %>%\n  dplyr::select(uniqueID, District)\n\nfishnet <- fishnet %>%\n  left_join(fishnet_districts, by = \"uniqueID\")\n\nfishnet_model <- fishnet %>%\n  filter(!is.na(sanitation_violations) & !is.na(sanitation.nn) & \n         !is.na(dist_to_hotspot) & !is.na(District))\n```\n:::\n\n\n### Fit Poisson Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_poisson <- glm(\n  countBurglaries ~ sanitation_violations + sanitation.nn + dist_to_hotspot,\n  family = \"poisson\",\n  data = fishnet_model\n)\n\nsummary(model_poisson)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = countBurglaries ~ sanitation_violations + sanitation.nn + \n    dist_to_hotspot, family = \"poisson\", data = fishnet_model)\n\nCoefficients:\n                         Estimate  Std. Error z value            Pr(>|z|)    \n(Intercept)            1.72136139  0.03385365   50.85 <0.0000000000000002 ***\nsanitation_violations  0.00286160  0.00015390   18.59 <0.0000000000000002 ***\nsanitation.nn         -0.00817539  0.00028246  -28.94 <0.0000000000000002 ***\ndist_to_hotspot       -0.00017981  0.00001681  -10.70 <0.0000000000000002 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 8956.5  on 2259  degrees of freedom\nResidual deviance: 5009.9  on 2256  degrees of freedom\nAIC: 10120\n\nNumber of Fisher Scoring iterations: 6\n```\n\n\n:::\n:::\n\n\n### Fit Negative Binomial Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_nb <- glm.nb(\n  countBurglaries ~ sanitation_violations + sanitation.nn + dist_to_hotspot,\n  data = fishnet_model\n)\n\nsummary(model_nb)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm.nb(formula = countBurglaries ~ sanitation_violations + sanitation.nn + \n    dist_to_hotspot, data = fishnet_model, init.theta = 2.496099382, \n    link = log)\n\nCoefficients:\n                         Estimate  Std. Error z value             Pr(>|z|)    \n(Intercept)            1.50713148  0.06142604  24.536 < 0.0000000000000002 ***\nsanitation_violations  0.00452346  0.00033341  13.567 < 0.0000000000000002 ***\nsanitation.nn         -0.00793662  0.00038734 -20.490 < 0.0000000000000002 ***\ndist_to_hotspot       -0.00012077  0.00002554  -4.728           0.00000227 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for Negative Binomial(2.4961) family taken to be 1)\n\n    Null deviance: 4353.3  on 2259  degrees of freedom\nResidual deviance: 2332.1  on 2256  degrees of freedom\nAIC: 9020.4\n\nNumber of Fisher Scoring iterations: 1\n\n              Theta:  2.496 \n          Std. Err.:  0.148 \n\n 2 x log-likelihood:  -9010.445 \n```\n\n\n:::\n:::\n\n\n### Model Comparison\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata.frame(\n  Model = c(\"Poisson\", \"Negative Binomial\"),\n  AIC = c(round(AIC(model_poisson), 2), round(AIC(model_nb), 2)),\n  BIC = c(round(BIC(model_poisson), 2), round(BIC(model_nb), 2))\n) %>%\n  kable(caption = \"Model Comparison\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Model Comparison</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Model </th>\n   <th style=\"text-align:right;\"> AIC </th>\n   <th style=\"text-align:right;\"> BIC </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Poisson </td>\n   <td style=\"text-align:right;\"> 10120.27 </td>\n   <td style=\"text-align:right;\"> 10143.16 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Negative Binomial </td>\n   <td style=\"text-align:right;\"> 9020.45 </td>\n   <td style=\"text-align:right;\"> 9049.06 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThe Negative Binomial model shows a lower AIC, indicating better fit. This confirms the presence of overdispersion problem in the burglary count data, justifying the use of the more flexible Negative Binomial specification.\n\n## Part 5: Spatial Cross-Validation\n\nLeave-One-Group-Out cross-validation by police district ensures spatial separation between training and test sets, preventing information leakage from nearby cells.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndistricts <- unique(fishnet_model$District)\ncv_results <- tibble()\n\nfor (i in seq_along(districts)) {\n  \n  test_district <- districts[i]\n  \n  train_data <- fishnet_model %>% filter(District != test_district)\n  test_data <- fishnet_model %>% filter(District == test_district)\n  \n  model_cv <- glm.nb(\n    countBurglaries ~ sanitation_violations + sanitation.nn + dist_to_hotspot,\n    data = train_data\n  )\n  \n  test_data <- test_data %>%\n    mutate(\n      prediction = predict(model_cv, test_data, type = \"response\")\n    )\n  \n  mae <- mean(abs(test_data$countBurglaries - test_data$prediction))\n  rmse <- sqrt(mean((test_data$countBurglaries - test_data$prediction)^2))\n  \n  cv_results <- bind_rows(\n    cv_results,\n    tibble(\n      fold = i,\n      test_district = test_district,\n      n_test = nrow(test_data),\n      mae = round(mae, 2),\n      rmse = round(rmse, 2)\n    )\n  )\n}\n```\n:::\n\n\n### Cross-Validation Results\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata.frame(\n  Metric = c(\"Mean MAE\", \"Mean RMSE\", \"SD of MAE\"),\n  Value = c(\n    round(mean(cv_results$mae), 2),\n    round(mean(cv_results$rmse), 2),\n    round(sd(cv_results$mae), 2)\n  )\n) %>%\n  kable(caption = \"Overall Cross-Validation Performance\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Overall Cross-Validation Performance</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Metric </th>\n   <th style=\"text-align:right;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Mean MAE </td>\n   <td style=\"text-align:right;\"> 2.29 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Mean RMSE </td>\n   <td style=\"text-align:right;\"> 3.58 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> SD of MAE </td>\n   <td style=\"text-align:right;\"> 0.84 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_results %>%\n  arrange(desc(mae)) %>%\n  kable(\n    digits = 2,\n    caption = \"LOGO Cross-Validation Results by District\"\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>LOGO Cross-Validation Results by District</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> fold </th>\n   <th style=\"text-align:left;\"> test_district </th>\n   <th style=\"text-align:right;\"> n_test </th>\n   <th style=\"text-align:right;\"> mae </th>\n   <th style=\"text-align:right;\"> rmse </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:right;\"> 65 </td>\n   <td style=\"text-align:right;\"> 4.18 </td>\n   <td style=\"text-align:right;\"> 6.11 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 19 </td>\n   <td style=\"text-align:left;\"> 19 </td>\n   <td style=\"text-align:right;\"> 92 </td>\n   <td style=\"text-align:right;\"> 3.71 </td>\n   <td style=\"text-align:right;\"> 8.32 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 18 </td>\n   <td style=\"text-align:left;\"> 14 </td>\n   <td style=\"text-align:right;\"> 65 </td>\n   <td style=\"text-align:right;\"> 3.55 </td>\n   <td style=\"text-align:right;\"> 5.67 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 16 </td>\n   <td style=\"text-align:left;\"> 18 </td>\n   <td style=\"text-align:right;\"> 45 </td>\n   <td style=\"text-align:right;\"> 3.26 </td>\n   <td style=\"text-align:right;\"> 4.67 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 21 </td>\n   <td style=\"text-align:left;\"> 17 </td>\n   <td style=\"text-align:right;\"> 98 </td>\n   <td style=\"text-align:right;\"> 2.75 </td>\n   <td style=\"text-align:right;\"> 8.31 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:right;\"> 82 </td>\n   <td style=\"text-align:right;\"> 2.68 </td>\n   <td style=\"text-align:right;\"> 3.74 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 15 </td>\n   <td style=\"text-align:left;\"> 11 </td>\n   <td style=\"text-align:right;\"> 65 </td>\n   <td style=\"text-align:right;\"> 2.66 </td>\n   <td style=\"text-align:right;\"> 3.23 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 23 </td>\n   <td style=\"text-align:left;\"> 24 </td>\n   <td style=\"text-align:right;\"> 54 </td>\n   <td style=\"text-align:right;\"> 2.60 </td>\n   <td style=\"text-align:right;\"> 3.32 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 13 </td>\n   <td style=\"text-align:left;\"> 12 </td>\n   <td style=\"text-align:right;\"> 98 </td>\n   <td style=\"text-align:right;\"> 2.57 </td>\n   <td style=\"text-align:right;\"> 3.72 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:right;\"> 67 </td>\n   <td style=\"text-align:right;\"> 2.44 </td>\n   <td style=\"text-align:right;\"> 3.41 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 17 </td>\n   <td style=\"text-align:left;\"> 25 </td>\n   <td style=\"text-align:right;\"> 113 </td>\n   <td style=\"text-align:right;\"> 2.41 </td>\n   <td style=\"text-align:right;\"> 3.34 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> 8 </td>\n   <td style=\"text-align:right;\"> 238 </td>\n   <td style=\"text-align:right;\"> 2.11 </td>\n   <td style=\"text-align:right;\"> 3.63 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:right;\"> 82 </td>\n   <td style=\"text-align:right;\"> 2.07 </td>\n   <td style=\"text-align:right;\"> 3.01 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 22 </td>\n   <td style=\"text-align:right;\"> 130 </td>\n   <td style=\"text-align:right;\"> 1.92 </td>\n   <td style=\"text-align:right;\"> 2.33 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 14 </td>\n   <td style=\"text-align:left;\"> 15 </td>\n   <td style=\"text-align:right;\"> 39 </td>\n   <td style=\"text-align:right;\"> 1.86 </td>\n   <td style=\"text-align:right;\"> 2.22 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 12 </td>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:right;\"> 47 </td>\n   <td style=\"text-align:right;\"> 1.84 </td>\n   <td style=\"text-align:right;\"> 2.41 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 22 </td>\n   <td style=\"text-align:left;\"> 20 </td>\n   <td style=\"text-align:right;\"> 48 </td>\n   <td style=\"text-align:right;\"> 1.77 </td>\n   <td style=\"text-align:right;\"> 2.25 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:right;\"> 129 </td>\n   <td style=\"text-align:right;\"> 1.71 </td>\n   <td style=\"text-align:right;\"> 2.98 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20 </td>\n   <td style=\"text-align:left;\"> 16 </td>\n   <td style=\"text-align:right;\"> 183 </td>\n   <td style=\"text-align:right;\"> 1.61 </td>\n   <td style=\"text-align:right;\"> 1.98 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> 9 </td>\n   <td style=\"text-align:right;\"> 140 </td>\n   <td style=\"text-align:right;\"> 1.59 </td>\n   <td style=\"text-align:right;\"> 2.28 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:left;\"> 10 </td>\n   <td style=\"text-align:right;\"> 85 </td>\n   <td style=\"text-align:right;\"> 1.51 </td>\n   <td style=\"text-align:right;\"> 2.20 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:right;\"> 276 </td>\n   <td style=\"text-align:right;\"> 1.16 </td>\n   <td style=\"text-align:right;\"> 2.45 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> 31 </td>\n   <td style=\"text-align:right;\"> 19 </td>\n   <td style=\"text-align:right;\"> 0.64 </td>\n   <td style=\"text-align:right;\"> 0.73 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThe cross-validation results show how well the model generalizes to unseen districts. Variation in MAE across districts reflects different relationships between sanitation violations and burglaries in different neighborhoods.\n\n## Part 6: Model Evaluation\n\n### Generate Final Predictions\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_model <- glm.nb(\n  countBurglaries ~ sanitation_violations + sanitation.nn + dist_to_hotspot,\n  data = fishnet_model\n)\n\nfishnet <- fishnet %>%\n  mutate(\n    prediction_nb = predict(final_model, fishnet_model, type = \"response\")[match(uniqueID, fishnet_model$uniqueID)]\n  )\n\nkde_sum <- sum(fishnet$kde_value, na.rm = TRUE)\ncount_sum <- sum(fishnet$countBurglaries, na.rm = TRUE)\nfishnet <- fishnet %>%\n  mutate(\n    prediction_kde = (kde_value / kde_sum) * count_sum\n  )\n```\n:::\n\n\n### Visual Comparison\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +\n  scale_fill_viridis_c(name = \"Count\", option = \"plasma\", limits = c(0, 15), trans = \"sqrt\") +\n  labs(title = \"Actual Burglaries\") +\n  theme_void()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = prediction_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 15), trans = \"sqrt\") +\n  labs(title = \"Model Predictions\") +\n  theme_void()\n\np3 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = prediction_kde), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 15), trans = \"sqrt\") +\n  labs(title = \"KDE Baseline\") +\n  theme_void()\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Actual vs. Predicted Burglaries\",\n    subtitle = \"Does the sanitation-based model outperform simple KDE?\"\n  )\n```\n\n::: {.cell-output-display}\n![](Fan_Yang_Assignment4_files/figure-html/compare-predictions-1.png){width=1152}\n:::\n:::\n\n\nThe regression model based on sanitation violations (middle) effectively captures the spatial distribution patterns of actual burglaries (left), with hot spot areas largely aligning. In contrast, while the KDE baseline model (right) also identifies major hot spots (even outperforming in the metric comparisons below), it exhibits blurred spatial details and excessive smoothing. Thus the regression model incorporating sanitation features preserves spatial details better, though its overall predictive capability may be comparable to or like inferior to KDE.\n\n### Performance Metrics\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomparison <- fishnet %>%\n  st_drop_geometry() %>%\n  filter(!is.na(prediction_nb), !is.na(prediction_kde)) %>%\n  summarize(\n    model_mae = round(mean(abs(countBurglaries - prediction_nb)), 2),\n    model_rmse = round(sqrt(mean((countBurglaries - prediction_nb)^2)), 2),\n    kde_mae = round(mean(abs(countBurglaries - prediction_kde)), 2),\n    kde_rmse = round(sqrt(mean((countBurglaries - prediction_kde)^2)), 2)\n  )\n\ncomparison %>%\n  pivot_longer(everything(), names_to = \"metric\", values_to = \"value\") %>%\n  separate(metric, into = c(\"approach\", \"metric\"), sep = \"_\") %>%\n  pivot_wider(names_from = metric, values_from = value) %>%\n  kable(caption = \"Model vs. KDE Performance\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Model vs. KDE Performance</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> approach </th>\n   <th style=\"text-align:right;\"> mae </th>\n   <th style=\"text-align:right;\"> rmse </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> model </td>\n   <td style=\"text-align:right;\"> 2.10 </td>\n   <td style=\"text-align:right;\"> 3.57 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> kde </td>\n   <td style=\"text-align:right;\"> 2.01 </td>\n   <td style=\"text-align:right;\"> 2.90 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nKDE performs better in statistical metrics, but as shown in the previous image, KDE's spatial representation is overly smooth and lacks detail. My predictive model, however, performs better at finer spatial granularity.\n\n### Error Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet_errors <- fishnet %>%\n  filter(!is.na(prediction_nb) & !is.na(countBurglaries)) %>%\n  mutate(\n    error_nb = countBurglaries - prediction_nb,\n    abs_error_nb = abs(error_nb)\n  )\n\np1 <- ggplot() +\n  geom_sf(data = fishnet_errors, aes(fill = error_nb), color = NA) +\n  scale_fill_gradient2(\n    name = \"Error\",\n    low = \"#2166ac\", mid = \"white\", high = \"#b2182b\",\n    midpoint = 0,\n    limits = c(-10, 10)\n  ) +\n  labs(title = \"Prediction Errors (Actual - Predicted)\") +\n  theme_void()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet_errors, aes(fill = abs_error_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Abs. Error\", option = \"magma\") +\n  labs(title = \"Absolute Errors\") +\n  theme_void()\n\np1 + p2\n```\n\n::: {.cell-output-display}\n![](Fan_Yang_Assignment4_files/figure-html/prediction-errors-1.png){width=960}\n:::\n:::\n\n\nThe model performs well overall: The random distribution of red and blue errors in the left image indicates no systematic bias, while the large dark areas in the right image demonstrate that absolute errors are generally small. Only a few scattered points show larger errors, meaning the model predicts accurately in most regions, but specific areas may require additional features for improved prediction.\n\n## Conclusion\n\n**Performance:** The negative binomial model achieved a cross-validation MAE of 2.29, performing roughly on par with the KDE baseline. All three spatial features demonstrated statistical significance. However, KDE exhibits overly smoothed predictions spatially, whereas my predictive model effectively captures fine-grained details consistent with actual values.\n\n**Spatial Patterns:** Sanitation hotspots and residential burglary hotspots show significant overlap, particularly in central and southern Chicago. This aligns with the Broken Windows theory—areas exhibiting visible disorder tend to experience higher rates of property crime.\n\n**Limitations:** Error analysis indicates that most predictions are accurate, but significant discrepancies exist in a few areas. These outliers may possess characteristics not captured by health data—potentially unusual building/land use types or specific economic and demographic conditions. Furthermore, relying solely on a single type of 311 call overlooks certain behavioral patterns.",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}